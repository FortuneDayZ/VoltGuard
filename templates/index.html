<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>VoltGuard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Material Icons for Chatbot -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,1,0" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Emoji Mart for Emoji Picker -->
  <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>

  <style>
    :root {
      --primary: #0d95b9;
      --accent: #fbc648;
      --glass-bg: rgba(255, 255, 255, 0.8);
      --glass-border: rgba(255, 255, 255, 0.3);
    }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(145deg, #e6f1f8, #f9f9f9);
      color: #333;
    }
    header {
      background: linear-gradient(90deg, var(--primary), #12b8c8);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    nav a {
      margin-left: 1.5rem;
      color: white;
      text-decoration: none;
      font-weight: 600;
      position: relative;
    }
    nav a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -4px;
      width: 100%;
      height: 2px;
      background-color: white;
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    nav a:hover::after {
      transform: scaleX(1);
    }
    .container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 2.5rem;
      padding: 2.5rem;
    }
    .section {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 1.5rem 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      margin-bottom: 2.5rem;
    }
    h2 {
      margin-top: 0;
      font-size: 1.3rem;
      color: var(--primary);
      border-left: 4px solid var(--accent);
      padding-left: 0.5rem;
    }
    input, select, button {
      margin-top: 0.5rem;
      padding: 0.6rem;
      width: 100%;
      margin-bottom: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }

  /* map container */
  .map-container {
  width: 100%;
  height: 300px;
  border-radius: 16px;
  overflow: hidden;
  }

    
    select {
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-color: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 0.6rem 2.5rem 0.6rem 0.75rem;
  font-size: 0.95rem;
  font-family: 'Inter', sans-serif;
  position: relative;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg fill='%230D95B9' viewBox='0 0 20 20'%3E%3Cpath d='M7 7l3 3 3-3'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  background-size: 1.25rem;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(13, 149, 185, 0.2);
  outline: none;
}

select:hover {
  border-color: var(--primary);
  cursor: pointer;
}


    button {
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background-color: #0b7fa1;
    }
    .device-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.95rem;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      overflow: hidden;
    }
    .device-table thead {
      background-color: var(--primary);
      color: white;
    }
    .device-table th, .device-table td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .device-table tr:nth-child(even) {
      background-color: #f4f9fc;
    }
    .device-table tr:hover {
      background-color: #eaf6fa;
    }
    .remove-btn {
      background-color: #f45c5c;
      border: none;
      padding: 0.4rem 0.8rem;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    .remove-btn:hover {
      background-color: #d84343;
    }
    .total-cost {
      text-align: right;
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 1.5rem;
      color: #333;
    }
    #categoryChart {
      max-width: 260px;
      max-height: 260px;
      margin: 0 auto;
      display: block;
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      padding: 1rem;
    }
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

    /* Chatbot Toggler */
    #chatbot-toggler {
      position: fixed;
      bottom: 30px;
      right: 35px;
      z-index: 9999; /* Ensure toggler is on top */
      border: none;
      height: 50px;
      width: 50px;
      display: flex;
      cursor: pointer;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: #5350C4;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    body.show-chatbot #chatbot-toggler {
      transform: rotate(90deg);
    }
    #chatbot-toggler span {
      color: #fff;
      position: absolute;
    }
    #chatbot-toggler span:last-child,
    body.show-chatbot #chatbot-toggler span:first-child {
      opacity: 0;
    }
    body.show-chatbot #chatbot-toggler span:last-child {
      opacity: 1;
    }

    /* Chatbot Popup */
    .chatbot-popup {
      position: fixed;
      bottom: 90px;
      right: 35px;
      width: 420px;
      max-height: 80vh; /* Constrain height so itâ€™s fully visible */
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 0 128px 0 rgba(0, 0, 0, 0.1),
      0 32px 64px -48px rgba(0, 0, 0, 0.5);
      z-index: 9998; /* Slightly below the toggler */
      opacity: 0;
      pointer-events: none;

      /* Flex layout so the header, body, and footer stack nicely */
      display: flex;
      flex-direction: column;

      /* Animation states */
      transform-origin: bottom right;
      transform: scale(0.8);
      transition: all 0.3s ease;
    }
    body.show-chatbot .chatbot-popup {
      opacity: 1;
      pointer-events: auto;
      transform: scale(1);
    }

    /* Chat Header */
    .chat-header {
      display: flex;
      align-items: center;
      padding: 15px 22px;
      background: #5350C4;
      justify-content: space-between;
    }
    .chat-header .header-info {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .chat-header .chatbot-logo {
      width: 35px;
      height: 35px;
      fill: #5350C4;
      background: #fff;
      padding: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .header-info .logo-text {
      color: #fff;
      font-weight: 600;
      font-size: 1.31rem;
      letter-spacing: 0.02rem;
    }
    .chat-header #close-chatbot {
      border: none;
      color: #fff;
      height: 40px;
      width: 40px;
      font-size: 1.9rem;
      padding-top: 2px;
      cursor: pointer;
      border-radius: 50%;
      background: none;
      transition: 0.2s ease;
    }
    .chat-header #close-chatbot:hover {
      background: #3d39ac;
    }

    /* Chat Body */
    .chat-body {
      flex: 1;               /* Allows chat body to grow/shrink */
      overflow-y: auto;      /* Scroll if content exceeds max-height */
      padding: 25px 22px;
      gap: 20px;
      display: flex;
      flex-direction: column;
      scrollbar-width: thin;
      scrollbar-color: #ccccf5 transparent;
    }
    .chat-body .message {
      display: flex;
      gap: 11px;
      align-items: center;
    }
    .chat-body .message .bot-avatar {
      width: 35px;
      height: 35px;
      fill: #fff;
      background: #5350C4;
      padding: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .chat-body .message .message-text {
      max-width: 75%;
      padding: 12px 16px;
      font-size: 0.95rem;
      word-wrap: break-word;
    }

    /* Bot & User Messages */
    .chat-body .bot-message .message-text {
      background: #F2F2FF;
      border-radius: 13px 13px 13px 3px;
    }
    .chat-body .user-message {
      flex-direction: column;
      align-items: flex-end;
    }
    .chat-body .user-message .message-text {
      color: #fff;
      background: #5350C4;
      border-radius: 13px 13px 3px 13px;
    }
    .chat-body .user-message .attachment {
      width: 50%;
      margin-top: -7px;
      border-radius: 13px 3px 13px 13px;
    }

    /* Thinking Indicator */
    .thinking-indicator {
      display: flex;
      gap: 4px;
      padding-block: 15px;
    }
    .thinking-indicator .dot {
      height: 7px;
      width: 7px;
      opacity: 0.7;
      border-radius: 50%;
      background: #6F6BC2;
      animation: dotPulse 1.8s ease-in-out infinite;
    }
    .thinking-indicator .dot:nth-child(1) {
      animation-delay: 0.2s;
    }
    .thinking-indicator .dot:nth-child(2) {
      animation-delay: 0.3s;
    }
    .thinking-indicator .dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes dotPulse {
      0%, 44% {
        transform: translateY(0);
      }
      28% {
        opacity: 0.4;
        transform: translateY(-4px);
      }
      44% {
        opacity: 0.2;
      }
    }

    /* Chat Footer */
    .chat-footer {
      background: #fff;
      padding: 15px 22px 20px;
      border-top: 1px solid #CCC;
    }
    .chat-form {
      display: flex;
      align-items: center;
      position: relative;
      background: #fff;
      border-radius: 32px;
      outline: 1px solid #CCCCE5;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.06);
      transition: 0s ease, border-radius 0s;
    }
    .chat-form:focus-within {
      outline: 2px solid #5350C4;
    }
    .message-input {
      width: 100%;
      height: 47px;
      outline: none;
      resize: none;
      border: none;
      max-height: 180px;
      scrollbar-width: thin;
      border-radius: inherit;
      font-size: 0.95rem;
      padding: 14px 0 12px 18px;
      scrollbar-color: transparent transparent;
    }
    .chat-controls {
      gap: 3px;
      height: 47px;
      display: flex;
      padding-right: 6px;
      align-items: center;
      align-self: flex-end;
    }
    .chat-controls button {
      height: 35px;
      width: 35px;
      border: none;
      cursor: pointer;
      color: #706DB0;
      border-radius: 50%;
      font-size: 1.15rem;
      background: none;
      transition: 0.2s ease;
    }
    .chat-controls button:hover,
    body.show-emoji-picker .chat-controls #emoji-picker {
      color: #3d39ac;
      background: #f1f1ff;
    }
    #send-message {
      color: #fff;
      display: none;
      background: #5350C4;
    }
    .message-input:valid ~ .chat-controls #send-message {
      display: block;
    }
    .file-upload-wrapper {
      position: relative;
      height: 35px;
      width: 35px;
    }
    .file-upload-wrapper :where(button, img) {
      position: absolute;
    }
    .file-upload-wrapper img {
      height: 100%;
      width: 100%;
      object-fit: cover;
      border-radius: 50%;
    }
    .file-upload-wrapper #file-cancel {
      color: #ff0000;
      background: #fff;
    }
    .file-upload-wrapper :where(img, #file-cancel),
    .file-upload-wrapper.file-uploaded #file-upload {
      display: none;
    }
    .file-upload-wrapper.file-uploaded img,
    .file-upload-wrapper.file-uploaded:hover #file-cancel {
      display: block;
    }
    em-emoji-picker {
      position: absolute;
      left: 50%;
      top: -337px;
      width: 100%;
      max-width: 350px;
      visibility: hidden;
      max-height: 330px;
      transform: translateX(-50%);
    }
    body.show-emoji-picker em-emoji-picker {
      visibility: visible;
    }

    /* Media Query for Mobile */
    @media (max-width: 520px) {
      #chatbot-toggler {
        right: 20px;
        bottom: 20px;
      }
      .chatbot-popup {
        right: 0;
        bottom: 0;
        width: 100%;
        max-height: 100vh; /* Use full screen on mobile */
        border-radius: 0;
      }
      .chat-header {
        padding: 12px 15px;
      }
      .chat-body {
        height: calc(100vh - 150px); /* Fills available space */
        padding: 25px 15px;
      }
      .chat-footer {
        padding: 10px 15px 15px;
      }
    }

  </style>
</head>
<body>
  <header>
    <h1>VoltGuard</h1>
    <nav>
      {% if user %}
        <a href="/logout">Logout</a>
      {% else %}
        <a href="/login">Login</a>
      {% endif %}
      <a href="#">Map</a>
      <a href="#">Advice</a>
    </nav>    
  </header>
  <div class="container">
    <!-- LEFT COLUMN -->
    <div>
<div class="section">
  <h2>Select Electricity Rate</h2>
  <label for="rateSelect">Choose Electricity Rate ($/kWh)</label>
  <select id="rateSelect">
    <option value="">-- Select a Standard Rate --</option>
    <option value="0.1505">Alabama - $0.1505</option>
    <option value="0.2474">Alaska - $0.2474</option>
    <option value="0.1475">Arizona - $0.1475</option>
    <option value="0.1125">Arkansas - $0.1125</option>
    <option value="0.3022">California - $0.3022</option>
    <option value="0.1501">Colorado - $0.1501</option>
    <option value="0.3006">Connecticut - $0.3006</option>
    <option value="0.1552">Delaware - $0.1552</option>
    <option value="0.1443">Florida - $0.1443</option>
    <option value="0.1352">Georgia - $0.1352</option>
    <option value="0.4051">Hawaii - $0.4051</option>
    <option value="0.1082">Idaho - $0.1082</option>
    <option value="0.1581">Illinois - $0.1581</option>
    <option value="0.1465">Indiana - $0.1465</option>
    <option value="0.1205">Iowa - $0.1205</option>
    <option value="0.1332">Kansas - $0.1332</option>
    <option value="0.1260">Kentucky - $0.1260</option>
    <option value="0.1100">Louisiana - $0.1100</option>
    <option value="0.2613">Maine - $0.2613</option>
    <option value="0.1826">Maryland - $0.1826</option>
    <option value="0.3008">Massachusetts - $0.3008</option>
    <option value="0.1850">Michigan - $0.1850</option>
    <option value="0.1453">Minnesota - $0.1453</option>
    <option value="0.1262">Mississippi - $0.1262</option>
    <option value="0.1119">Missouri - $0.1119</option>
    <option value="0.1141">Montana - $0.1141</option>
    <option value="0.1056">Nebraska - $0.1056</option>
    <option value="0.1392">Nevada - $0.1392</option>
    <option value="0.2340">New Hampshire - $0.2340</option>
    <option value="0.1968">New Jersey - $0.1968</option>
    <option value="0.1373">New Mexico - $0.1373</option>
    <option value="0.2531">New York - $0.2531</option>
    <option value="0.1247">North Carolina - $0.1247</option>
    <option value="0.0993">North Dakota - $0.0993</option>
    <option value="0.1564">Ohio - $0.1564</option>
    <option value="0.1102">Oklahoma - $0.1102</option>
    <option value="0.1444">Oregon - $0.1444</option>
    <option value="0.1758">Pennsylvania - $0.1758</option>
    <option value="0.3166">Rhode Island - $0.3166</option>
    <option value="0.1381">South Carolina - $0.1381</option>
    <option value="0.1209">South Dakota - $0.1209</option>
    <option value="0.1270">Tennessee - $0.1270</option>
    <option value="0.1468">Texas - $0.1468</option>
    <option value="0.1212">Utah - $0.1212</option>
    <option value="0.2195">Vermont - $0.2195</option>
    <option value="0.1404">Virginia - $0.1404</option>
    <option value="0.1179">Washington - $0.1179</option>
    <option value="0.1447">West Virginia - $0.1447</option>
    <option value="0.1742">Wisconsin - $0.1742</option>
    <option value="0.1169">Wyoming - $0.1169</option>
    <option value="0.1595">United States (Average) - $0.1595</option>
  </select>
  
  <input type="number" id="rateInput" step="0.01" placeholder="Or enter your rate ($/kWh)" value="" />
</div>

      <div class="section">
        <h2>Add Device Usage</h2>
        <input type="text" id="nameInput" placeholder="Device Name" />
        <input type="number" id="wattsInput" placeholder="Watts Used" />
        <input type="number" id="hoursInput" placeholder="Hours per Day" />
        <select id="categorySelect">
          <option value="">Select Category</option>
          <option>Appliances</option>
          <option>Personal Electronics</option>
          <option>Heating & Cooling</option>
          <option>Lighting</option>
          <option>Kitchen & Cooking</option>
          <option>Outdoor / Utility</option>
          <option>Miscellaneous</option>
        </select>
        <button id="addButton">Add Appliance</button>
      </div>

      <div class="section">
        <h2>Devices You've Added</h2>
        <table class="device-table">
<thead>
  <tr>
    <th>Appliance</th>
    <th>Category</th>
    <th>Usage (hrs) </th>
    <th>Watts</th>
    <th>kWh/day</th>
    <th>Cost</th>
    <th>Actions</th>
  </tr>
</thead>

          <tbody id="deviceBody"></tbody>
        </table>
        <div class="total-cost">
          <strong>Total Daily Cost:</strong> <span id="totalCost">$0.00</span>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div>
      <div class="section">
        <h2>Map (Placeholder)</h2>
        <div id="map" class="map-container"></div>
      </div>

      <div class="section">
        <h2>Electricity Cost by Category</h2>
        <canvas id="categoryChart"></canvas>
      </div>

    </div>
  </div>


  <!-- =========================
     Chatbot Toggler & Popup (Floating)
     ========================= -->
  <button id="chatbot-toggler">
    <span class="material-symbols-rounded">mode_comment</span>
    <span class="material-symbols-rounded">close</span>
  </button>
  <div class="chatbot-popup">
    <!-- Chatbot Header -->
    <div class="chat-header">
      <div class="header-info">
        <svg class="chatbot-logo" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 1024 1024">
          <path d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"></path>
        </svg>
        <h2 class="logo-text">VoltBot</h2>
      </div>
      <button id="close-chatbot" class="material-symbols-rounded">keyboard_arrow_down</button>
    </div>
    <!-- Chatbot Body -->
    <div class="chat-body">
      <div class="message bot-message">
        <svg class="bot-avatar" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 1024 1024">
          <path d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"></path>
        </svg>
        <div class="message-text">
          Hey there<br />How can I help you today?
        </div>
      </div>
    </div>
    <!-- Chatbot Footer -->
    <div class="chat-footer">
      <form action="#" class="chat-form">
        <textarea placeholder="Message..." class="message-input" required></textarea>
        <div class="chat-controls">
          <button type="button" id="emoji-picker" class="material-symbols-outlined">sentiment_satisfied</button>
          <div class="file-upload-wrapper">
            <input type="file" accept="image/*" id="file-input" hidden />
            <img src="#" alt="attachment preview" />
            <button type="button" id="file-upload" class="material-symbols-rounded">attach_file</button>
            <button type="button" id="file-cancel" class="material-symbols-rounded">close</button>
          </div>
          <button type="submit" id="send-message" class="material-symbols-rounded">arrow_upward</button>
        </div>
      </form>
    </div>
  </div>


  <script>
    const deviceList = [];
    const rateSelect = document.getElementById('rateSelect');
    const rateInput = document.getElementById('rateInput');
    const nameInput = document.getElementById('nameInput');
    const wattsInput = document.getElementById('wattsInput');
    const hoursInput = document.getElementById('hoursInput');
    const categoryInput = document.getElementById('categorySelect');
    const addButton = document.getElementById('addButton');
    const tbody = document.getElementById('deviceBody');
    const totalCostDisplay = document.getElementById('totalCost');
    let chart;
    let editIndex = -1;

    const predefinedDevices = {
      'Laptop': { watts: 50, hours: 3 },
      'Fridge': { watts: 150, hours: 24 },
      'Microwave': { watts: 1000, hours: 1 }
    };

    nameInput.addEventListener('input', () => {
      const val = nameInput.value.trim();
      if (predefinedDevices[val]) {
        wattsInput.value = predefinedDevices[val].watts;
        hoursInput.value = predefinedDevices[val].hours;
      }
    });

    function showToast(msg) {
      const toast = document.createElement('div');
      toast.textContent = msg;
      toast.style.position = 'fixed';
      toast.style.bottom = '1rem';
      toast.style.right = '1rem';
      toast.style.background = '#0d95b9';
      toast.style.color = 'white';
      toast.style.padding = '0.75rem 1.25rem';
      toast.style.borderRadius = '8px';
      toast.style.boxShadow = '0 4px 10px rgba(0,0,0,0.1)';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function calculateRate() {
      let rateStr = rateSelect.value.split(' - ')[1];
      let rate = rateStr ? parseFloat(rateStr) / 100 : parseFloat(rateInput.value);
      return isNaN(rate) ? 0.1289 : rate;
    }

    function recalculateTotal() {
      const rate = calculateRate();
      let total = 0;
      deviceList.forEach(device => {
        total += (device.watts * device.hours / 1000) * rate;
      });
      totalCostDisplay.textContent = `$${total.toFixed(2)}`;
    }

    function renderDevices() {
      tbody.innerHTML = '';
      deviceList.forEach((device, index) => {
        const tr = document.createElement('tr');
tr.innerHTML = `
  <td>${device.name}</td>
  <td>${device.category}</td>
  <td>${device.hours}</td>
  <td>${device.watts}</td>
  <td>${(device.hours * device.watts / 1000).toFixed(2)}</td>
  <td>$${((device.hours * device.watts / 1000) * calculateRate()).toFixed(3)}</td>
  <td>
    <button class="remove-btn" onclick="removeDevice(${index})">Remove</button>
    <button class="remove-btn" style="background-color: #fbc648" onclick="editDevice(${index})">Edit</button>
  </td>`;

        tbody.appendChild(tr);
      });
      recalculateTotal();
      updatePieChart();
    }

    async function removeDevice(index) {
  const { id } = deviceList[index];
  const res = await fetch(`/api/devices/${id}`, { method: 'DELETE' });
  if (!res.ok) {
    return showToast('Failed to remove device.');
  }
  deviceList.splice(index, 1);
  renderDevices();
  showToast('Device removed.');
}


function editDevice(index) {
  const device = deviceList[index];
  nameInput.value = device.name;
  wattsInput.value = device.watts;
  hoursInput.value = device.hours;
  categoryInput.value = device.category;
  editIndex = index; 
  showToast('Editing device.');
}



addButton.addEventListener('click', async () => {
  const name     = nameInput.value.trim();
  const watts    = parseFloat(wattsInput.value);
  const hours    = parseFloat(hoursInput.value);
  const category = categoryInput.value;

  if (!name || isNaN(watts) || isNaN(hours) || !category) {
    return showToast('Please complete all fields including category.');
  }

  if (editIndex !== -1) {
    const device = deviceList[editIndex];
    const res = await fetch(`/api/devices/${device.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, watts, hours, category })
    });

    if (!res.ok) {
      showToast('Failed to update device.');
      return;
    }

    deviceList[editIndex] = { id: device.id, name, watts, hours, category };
    editIndex = -1;
    showToast('Device updated!');
  } else {
    const res = await fetch('/api/devices', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, watts, hours, category })
    });

    if (!res.ok) {
      showToast('Failed to save device.');
      return;
    }

    const { id } = await res.json();
    deviceList.push({ id, name, watts, hours, category });
    showToast('Device added!');
  }

  renderDevices();
  nameInput.value = wattsInput.value = hoursInput.value = '';
  categoryInput.value = '';
});


    rateSelect.addEventListener('change', () => {
      showToast('Rate updated. Recalculating...');
      recalculateTotal();
      updatePieChart();
    });

    rateInput.addEventListener('input', () => {
      showToast('Rate updated. Recalculating...');
      recalculateTotal();
      updatePieChart();
    });

function updatePieChart() {
  const categoryData = {};
  const rate = calculateRate();
  deviceList.forEach(device => {
    const energy = (device.watts * device.hours / 1000) * rate;
    categoryData[device.category] = (categoryData[device.category] || 0) + energy;
  });

  const labels = Object.keys(categoryData);
  const data = Object.values(categoryData);
  const total = data.reduce((a, b) => a + b, 0);

  const colors = ['#6EB7C9', '#FBC648', '#CB2C3C', '#C3E6CB', '#E6C3F1', '#FFD6A5', '#0D95B9'];

  if (chart) chart.destroy();
  const ctx = document.getElementById('categoryChart').getContext('2d');

  chart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors,
        borderColor: '#fff',
        borderWidth: 2,
        borderRadius: 12,
        hoverOffset: 8
      }]
    },
    options: {
      responsive: true,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            font: {
              size: 14,
              weight: '600'
            },
            color: '#333'
          }
        },
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.label}: $${ctx.raw.toFixed(2)}`
          },
          backgroundColor: '#fff',
          titleColor: '#333',
          bodyColor: '#333',
          borderColor: '#ccc',
          borderWidth: 1
        }
      }
    },
    plugins: [{
      id: 'centerText',
      beforeDraw(chart) {
        const { width, height, ctx } = chart;
        ctx.restore();
        const fontSize = (height / 140).toFixed(2);
        ctx.font = `bold ${fontSize}em Inter`;
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#333';

        const text = `$${total.toFixed(2)}`;
        const textX = Math.round((width - ctx.measureText(text).width) / 2);
        const textY = height / 2 - 25;
        ctx.fillText(text, textX, textY);

        ctx.font = `14px Inter`;
        const subtext = "Total";
        const subX = Math.round((width - ctx.measureText(subtext).width) / 2);
        ctx.fillStyle = '#666';
        ctx.fillText(subtext, subX, textY + 20);
        ctx.save();
      }
    }]
  });
}
window.addEventListener('load', async () => {
  const r = await fetch('/api/rate');
  if (r.ok) {
    const { rate } = await r.json();

    if (rate) { 
      let matched = false;
      for (let i = 0; i < rateSelect.options.length; i++) {
        if (parseFloat(rateSelect.options[i].value) === parseFloat(rate)) {
          rateSelect.selectedIndex = i;
          matched = true;
          break;
        }
      }
      if (!matched) {
        rateInput.value = rate !== 0 ? rate : '';
      }
    } else {
      rateInput.value = '';
    }

    recalculateTotal();
  }

  const d = await fetch('/api/devices');
  if (d.ok) {
    const list = await d.json();
    deviceList.splice(0, deviceList.length,
      ...list.map(dev => ({
        id:       dev.id,
        name:     dev.name,
        watts:    dev.watts,
        hours:    dev.hours,
        category: dev.category
      }))
    );
    renderDevices();
  }
});



    /* ----- Chatbot Script ----- */

    // DOM elements for chatbot
    const chatBody = document.querySelector(".chat-body");
    const messageInput = document.querySelector(".message-input");
    const sendMessage = document.querySelector("#send-message");
    const fileInput = document.querySelector("#file-input");
    const fileUploadWrapper = document.querySelector(".file-upload-wrapper");
    const fileCancelButton = fileUploadWrapper.querySelector("#file-cancel");
    const chatbotToggler = document.querySelector("#chatbot-toggler");
    const closeChatbot = document.querySelector("#close-chatbot");

    // API setup for Google AI Gemini
    const API_KEY = "AIzaSyDFHTI9_rY_vzwX1mjRdo0hsvtz265Tkw8"; // Replace with your key
    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;

    // User message and file data storage
    const userData = {
      message: null,
      file: {
        data: null,
        mime_type: null,
      },
    };

    // Store chat history for context
    const chatHistory = [];
    const initialInputHeight = messageInput.scrollHeight;

    // Create a message element with optional classes
    const createMessageElement = (content, ...classes) => {
      const div = document.createElement("div");
      div.classList.add("message", ...classes);
      div.innerHTML = content;
      return div;
    };

    // Generate bot response by calling Google AI Gemini API
    const generateBotResponse = async (incomingMessageDiv) => {
      const messageElement = incomingMessageDiv.querySelector(".message-text");
      // Add user message to chat history
      chatHistory.push({
        role: "user",
        parts: [{ text: userData.message }],
        ...(userData.file.data ? { file: userData.file } : {})
      });
      const requestOptions = {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: chatHistory,
        }),
      };
      try {
        const response = await fetch(API_URL, requestOptions);
        const data = await response.json();
        if (!response.ok) throw new Error(data.error.message);
        const apiResponseText = data.candidates[0].content.parts[0].text.replace(/\*\*(.*?)\*\*/g, "$1").trim();
        messageElement.innerText = apiResponseText;
        chatHistory.push({
          role: "model",
          parts: [{ text: apiResponseText }],
        });
      } catch (error) {
        console.error(error);
        messageElement.innerText = error.message;
        messageElement.style.color = "#ff0000";
      } finally {
        userData.file = {};
        incomingMessageDiv.classList.remove("thinking");
        chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });
      }
    };

    // Handle sending outgoing messages
    const handleOutgoingMessage = (e) => {
      e.preventDefault();
      userData.message = messageInput.value.trim();
      messageInput.value = "";
      messageInput.dispatchEvent(new Event("input"));
      fileUploadWrapper.classList.remove("file-uploaded");
      const messageContent = `<div class="message-text"></div>
                                ${userData.file.data ? `<img src="data:${userData.file.mime_type};base64,${userData.file.data}" class="attachment" />` : ""}`;
      const outgoingMessageDiv = createMessageElement(messageContent, "user-message");
      outgoingMessageDiv.querySelector(".message-text").innerText = userData.message;
      chatBody.appendChild(outgoingMessageDiv);
      chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });
      setTimeout(() => {
        const content = `<svg class="bot-avatar" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 1024 1024">
            <path d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"/>
          </svg>
          <div class="message-text">
            <div class="thinking-indicator">
              <div class="dot"></div>
              <div class="dot"></div>
              <div class="dot"></div>
            </div>
          </div>`;
        const incomingMessageDiv = createMessageElement(content, "bot-message", "thinking");
        chatBody.appendChild(incomingMessageDiv);
        chatBody.scrollTo({ top: chatBody.scrollHeight, behavior: "smooth" });
        generateBotResponse(incomingMessageDiv);
      }, 600);
    };

    // Dynamic adjustment of the message input height
    messageInput.addEventListener("input", () => {
      messageInput.style.height = `${initialInputHeight}px`;
      messageInput.style.height = `${messageInput.scrollHeight}px`;
      document.querySelector(".chat-form").style.borderRadius = messageInput.scrollHeight > initialInputHeight ? "15px" : "32px";
    });

    // Sending message on Enter (for larger screens)
    messageInput.addEventListener("keydown", (e) => {
      const userMessage = e.target.value.trim();
      if (e.key === "Enter" && !e.shiftKey && userMessage && window.innerWidth > 768) {
        handleOutgoingMessage(e);
      }
    });

    // File upload handler
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        fileInput.value = "";
        fileUploadWrapper.querySelector("img").src = e.target.result;
        fileUploadWrapper.classList.add("file-uploaded");
        const base64String = e.target.result.split(",")[1];
        userData.file = {
          data: base64String,
          mime_type: file.type,
        };
      };
      reader.readAsDataURL(file);
    });

    // Cancel file upload
    fileCancelButton.addEventListener("click", () => {
      userData.file = {};
      fileUploadWrapper.classList.remove("file-uploaded");
    });

    // Initialize emoji picker
    const picker = new EmojiMart.Picker({
      theme: "light",
      skinTonePosition: "none",
      previewPosition: "none",
      onEmojiSelect: (emoji) => {
        const { selectionStart: start, selectionEnd: end } = messageInput;
        messageInput.setRangeText(emoji.native, start, end, "end");
        messageInput.focus();
      },
      onClickOutside: (e) => {
        if (e.target.id === "emoji-picker") {
          document.body.classList.toggle("show-emoji-picker");
        } else {
          document.body.classList.remove("show-emoji-picker");
        }
      },
    });
    document.querySelector(".chat-form").appendChild(picker);

    // Event listeners for sending messages and file upload interactions
    sendMessage.addEventListener("click", (e) => handleOutgoingMessage(e));
    document.querySelector("#file-upload").addEventListener("click", () => fileInput.click());
    closeChatbot.addEventListener("click", () => document.body.classList.remove("show-chatbot"));
    chatbotToggler.addEventListener("click", () => document.body.classList.toggle("show-chatbot"));


  </script>
 

<script>
  let map;
  let infoWindow;

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 39.8283, lng: -98.5795 },
      zoom: 4
    });
    infoWindow = new google.maps.InfoWindow();
  }

  rateSelect.addEventListener("change", () => {
    const text   = rateSelect.options[rateSelect.selectedIndex].text; 
    const region = text.split(" - ")[0];
    const rate   = rateSelect.value;
    updateMapRegion(region, rate);
  });
  
  function updateMapRegion(region, rate) {
    let center, zoom;
    switch (region) {
  case "Alabama":
    center = { lat: 32.806671, lng: -86.791130 }; zoom = 6; break;
  case "Alaska":
    center = { lat: 61.370716, lng: -152.404419 }; zoom = 4; break;
  case "Arizona":
    center = { lat: 33.729759, lng: -111.431221 }; zoom = 6; break;
  case "Arkansas":
    center = { lat: 34.969704, lng: -92.373123  }; zoom = 6; break;
  case "California":
    center = { lat: 36.116203, lng: -119.681564 }; zoom = 6; break;
  case "Colorado":
    center = { lat: 39.059811, lng: -105.311104 }; zoom = 6; break;
  case "Connecticut":
    center = { lat: 41.597782, lng: -72.755371  }; zoom = 7; break;
  case "Delaware":
    center = { lat: 39.318523, lng: -75.507141  }; zoom = 7; break;
  case "Florida":
    center = { lat: 27.766279, lng: -81.686783  }; zoom = 6; break;
  case "Georgia":
    center = { lat: 33.040619, lng: -83.643074  }; zoom = 6; break;
  case "Hawaii":
    center = { lat: 21.094318, lng: -157.498337 }; zoom = 5; break;
  case "Idaho":
    center = { lat: 44.240459, lng: -114.478828 }; zoom = 6; break;
  case "Illinois":
    center = { lat: 40.349457, lng: -88.986137  }; zoom = 6; break;
  case "Indiana":
    center = { lat: 39.849426, lng: -86.258278  }; zoom = 6; break;
  case "Iowa":
    center = { lat: 42.011539, lng: -93.210526  }; zoom = 6; break;
  case "Kansas":
    center = { lat: 38.526600, lng: -96.726486  }; zoom = 6; break;
  case "Kentucky":
    center = { lat: 37.668140, lng: -84.670067  }; zoom = 6; break;
  case "Louisiana":
    center = { lat: 31.169546, lng: -91.867805  }; zoom = 6; break;
  case "Maine":
    center = { lat: 44.693947, lng: -69.381927  }; zoom = 6; break;
  case "Maryland":
    center = { lat: 39.063946, lng: -76.802101  }; zoom = 6; break;
  case "Massachusetts":
    center = { lat: 42.230171, lng: -71.530106  }; zoom = 7; break;
  case "Michigan":
    center = { lat: 43.326618, lng: -84.536095  }; zoom = 6; break;
  case "Minnesota":
    center = { lat: 45.694454, lng: -93.900192  }; zoom = 6; break;
  case "Mississippi":
    center = { lat: 32.741646, lng: -89.678696  }; zoom = 6; break;
  case "Missouri":
    center = { lat: 38.456085, lng: -92.288368  }; zoom = 6; break;
  case "Montana":
    center = { lat: 46.921925, lng: -110.454353 }; zoom = 5; break;
  case "Nebraska":
    center = { lat: 41.125370, lng: -98.268082  }; zoom = 6; break;
  case "Nevada":
    center = { lat: 38.313515, lng: -117.055374 }; zoom = 6; break;
  case "New Hampshire":
    center = { lat: 43.452492, lng: -71.563896  }; zoom = 7; break;
  case "New Jersey":
    center = { lat: 40.298904, lng: -74.521011  }; zoom = 7; break;
  case "New Mexico":
    center = { lat: 34.840515, lng: -106.248482 }; zoom = 6; break;
  case "New York":
    center = { lat: 42.165726, lng: -74.948051  }; zoom = 6; break;
  case "North Carolina":
    center = { lat: 35.630066, lng: -79.806419  }; zoom = 6; break;
  case "North Dakota":
    center = { lat: 47.528912, lng: -99.784012  }; zoom = 6; break;
  case "Ohio":
    center = { lat: 40.388783, lng: -82.764915  }; zoom = 6; break;
  case "Oklahoma":
    center = { lat: 35.565342, lng: -96.928917  }; zoom = 6; break;
  case "Oregon":
    center = { lat: 44.572021, lng: -122.070938 }; zoom = 6; break;
  case "Pennsylvania":
    center = { lat: 40.590752, lng: -77.209755  }; zoom = 6; break;
  case "Rhode Island":
    center = { lat: 41.680893, lng: -71.511780  }; zoom = 8; break;
  case "South Carolina":
    center = { lat: 33.856892, lng: -80.945007  }; zoom = 6; break;
  case "South Dakota":
    center = { lat: 44.299782, lng: -99.438828  }; zoom = 6; break;
  case "Tennessee":
    center = { lat: 35.747845, lng: -86.692345  }; zoom = 6; break;
  case "Texas":
    center = { lat: 31.054487, lng: -97.563461  }; zoom = 6; break;
  case "Utah":
    center = { lat: 39.419220, lng: -111.950684 }; zoom = 6; break;
  case "Vermont":
    center = { lat: 44.040656, lng: -72.709146  }; zoom = 7; break;
  case "Virginia":
    center = { lat: 37.769337, lng: -78.169968  }; zoom = 6; break;
  case "Washington":
    center = { lat: 47.400902, lng: -121.490494 }; zoom = 6; break;
  case "West Virginia":
    center = { lat: 38.491226, lng: -80.954453  }; zoom = 6; break;
  case "Wisconsin":
    center = { lat: 44.268543, lng: -89.616508  }; zoom = 6; break;
  case "Wyoming":
    center = { lat: 42.755966, lng: -107.302490 }; zoom = 6; break;
  default:
    center = { lat: 39.828300, lng: -98.579500 }; zoom = 4;
}

    map.setCenter(center);
    map.setZoom(zoom);
    infoWindow.setContent(`
      <div style="font-size:14px;">
        <strong>${region}</strong><br>
        Rate: $${parseFloat(rate).toFixed(2)}/kWh
      </div>`);
    infoWindow.setPosition(center);
    infoWindow.open(map);
  }


  rateSelect.addEventListener("change", () => {
    const idx = rateSelect.selectedIndex;
    const text = rateSelect.options[idx].text;  
    const region = text.split(" - ")[0]; 
    const rate = rateSelect.value;  
    updateMapRegion(region, rate);
  });
</script>


<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC06eHiZTAYQqwxNk8jehhcx2YmKlzwYvA&callback=initMap">
</script>



</body>
</html>